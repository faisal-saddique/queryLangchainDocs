Zep
===

Retriever Example for [Zep](https://docs.getzep.com/) - A long-term memory store for LLM applications.[​](#retriever-example-for-zep---a-long-term-memory-store-for-llm-applications "Direct link to retriever-example-for-zep---a-long-term-memory-store-for-llm-applications")
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

### More on Zep:[​](#more-on-zep "Direct link to More on Zep:")

Zep stores, summarizes, embeds, indexes, and enriches conversational AI chat histories, and exposes them via simple, low-latency APIs.

Key Features:

*   **Fast!** Zep’s async extractors operate independently of the your chat loop, ensuring a snappy user experience.
*   **Long-term memory persistence**, with access to historical messages irrespective of your summarization strategy.
*   **Auto-summarization** of memory messages based on a configurable message window. A series of summaries are stored, providing flexibility for future summarization strategies.
*   **Hybrid search** over memories and metadata, with messages automatically embedded on creation.
*   **Entity Extractor** that automatically extracts named entities from messages and stores them in the message metadata.
*   **Auto-token counting** of memories and summaries, allowing finer-grained control over prompt assembly.
*   Python and JavaScript SDKs.

Zep project: [https://github.com/getzep/zep](https://github.com/getzep/zep) Docs: [https://docs.getzep.com/](https://docs.getzep.com/)

Retriever Example[​](#retriever-example "Direct link to Retriever Example")
---------------------------------------------------------------------------

This notebook demonstrates how to search historical chat message histories using the [Zep Long-term Memory Store](https://getzep.github.io/).

We'll demonstrate:

1.  Adding conversation history to the Zep memory store.
2.  Vector search over the conversation history.

    from langchain.memory.chat_message_histories import ZepChatMessageHistoryfrom langchain.schema import HumanMessage, AIMessagefrom uuid import uuid4import getpass# Set this to your Zep server URLZEP_API_URL = "http://localhost:8000"

### Initialize the Zep Chat Message History Class and add a chat message history to the memory store[​](#initialize-the-zep-chat-message-history-class-and-add-a-chat-message-history-to-the-memory-store "Direct link to Initialize the Zep Chat Message History Class and add a chat message history to the memory store")

**NOTE:** Unlike other Retrievers, the content returned by the Zep Retriever is session/user specific. A `session_id` is required when instantiating the Retriever.

    # Provide your Zep API key. Note that this is optional. See https://docs.getzep.com/deployment/authzep_api_key = getpass.getpass()

         ········

    session_id = str(uuid4())  # This is a unique identifier for the user/session# Set up Zep Chat History. We'll use this to add chat histories to the memory storezep_chat_history = ZepChatMessageHistory(    session_id=session_id, url=ZEP_API_URL, api_key=zep_api_key)

    # Preload some messages into the memory. The default message window is 12 messages. We want to push beyond this to demonstrate auto-summarization.test_history = [    {"role": "human", "content": "Who was Octavia Butler?"},    {        "role": "ai",        "content": (            "Octavia Estelle Butler (June 22, 1947 – February 24, 2006) was an American"            " science fiction author."        ),    },    {"role": "human", "content": "Which books of hers were made into movies?"},    {        "role": "ai",        "content": (            "The most well-known adaptation of Octavia Butler's work is the FX series"            " Kindred, based on her novel of the same name."        ),    },    {"role": "human", "content": "Who were her contemporaries?"},    {        "role": "ai",        "content": (            "Octavia Butler's contemporaries included Ursula K. Le Guin, Samuel R."            " Delany, and Joanna Russ."        ),    },    {"role": "human", "content": "What awards did she win?"},    {        "role": "ai",        "content": (            "Octavia Butler won the Hugo Award, the Nebula Award, and the MacArthur"            " Fellowship."        ),    },    {        "role": "human",        "content": "Which other women sci-fi writers might I want to read?",    },    {        "role": "ai",        "content": "You might want to read Ursula K. Le Guin or Joanna Russ.",    },    {        "role": "human",        "content": (            "Write a short synopsis of Butler's book, Parable of the Sower. What is it"            " about?"        ),    },    {        "role": "ai",        "content": (            "Parable of the Sower is a science fiction novel by Octavia Butler,"            " published in 1993. It follows the story of Lauren Olamina, a young woman"            " living in a dystopian future where society has collapsed due to"            " environmental disasters, poverty, and violence."        ),    },]for msg in test_history:    zep_chat_history.add_message(        HumanMessage(content=msg["content"])        if msg["role"] == "human"        else AIMessage(content=msg["content"])    )

### Use the Zep Retriever to vector search over the Zep memory[​](#use-the-zep-retriever-to-vector-search-over-the-zep-memory "Direct link to Use the Zep Retriever to vector search over the Zep memory")

Zep provides native vector search over historical conversation memory. Embedding happens automatically.

NOTE: Embedding of messages occurs asynchronously, so the first query may not return results. Subsequent queries will return results as the embeddings are generated.

    from langchain.retrievers import ZepRetrieverzep_retriever = ZepRetriever(    session_id=session_id,  # Ensure that you provide the session_id when instantiating the Retriever    url=ZEP_API_URL,    top_k=5,    api_key=zep_api_key,)await zep_retriever.aget_relevant_documents("Who wrote Parable of the Sower?")

        [Document(page_content='Parable of the Sower is a science fiction novel by Octavia Butler, published in 1993. It follows the story of Lauren Olamina, a young woman living in a dystopian future where society has collapsed due to environmental disasters, poverty, and violence.', metadata={'score': 0.8897116216176073, 'uuid': 'db60ff57-f259-4ec4-8a81-178ed4c6e54f', 'created_at': '2023-06-26T23:40:22.816214Z', 'role': 'ai', 'metadata': {'system': {'entities': [{'Label': 'GPE', 'Matches': [{'End': 20, 'Start': 15, 'Text': 'Sower'}], 'Name': 'Sower'}, {'Label': 'PERSON', 'Matches': [{'End': 65, 'Start': 51, 'Text': 'Octavia Butler'}], 'Name': 'Octavia Butler'}, {'Label': 'DATE', 'Matches': [{'End': 84, 'Start': 80, 'Text': '1993'}], 'Name': '1993'}, {'Label': 'PERSON', 'Matches': [{'End': 124, 'Start': 110, 'Text': 'Lauren Olamina'}], 'Name': 'Lauren Olamina'}]}}, 'token_count': 56}),     Document(page_content="Write a short synopsis of Butler's book, Parable of the Sower. What is it about?", metadata={'score': 0.8856661080361157, 'uuid': 'f1a5981a-8f6d-4168-a548-6e9c32f35fa1', 'created_at': '2023-06-26T23:40:22.809621Z', 'role': 'human', 'metadata': {'system': {'entities': [{'Label': 'ORG', 'Matches': [{'End': 32, 'Start': 26, 'Text': 'Butler'}], 'Name': 'Butler'}, {'Label': 'WORK_OF_ART', 'Matches': [{'End': 61, 'Start': 41, 'Text': 'Parable of the Sower'}], 'Name': 'Parable of the Sower'}]}}, 'token_count': 23}),     Document(page_content='Who was Octavia Butler?', metadata={'score': 0.7757595298492976, 'uuid': '361d0043-1009-4e13-a7f0-8aea8b1ee869', 'created_at': '2023-06-26T23:40:22.709886Z', 'role': 'human', 'metadata': {'system': {'entities': [{'Label': 'PERSON', 'Matches': [{'End': 22, 'Start': 8, 'Text': 'Octavia Butler'}], 'Name': 'Octavia Butler'}], 'intent': 'The subject wants to know about the identity or background of an individual named Octavia Butler.'}}, 'token_count': 8}),     Document(page_content="Octavia Butler's contemporaries included Ursula K. Le Guin, Samuel R. Delany, and Joanna Russ.", metadata={'score': 0.7601242516059306, 'uuid': '56c45e8a-0f65-45f0-bc46-d9e65164b563', 'created_at': '2023-06-26T23:40:22.778836Z', 'role': 'ai', 'metadata': {'system': {'entities': [{'Label': 'PERSON', 'Matches': [{'End': 16, 'Start': 0, 'Text': "Octavia Butler's"}], 'Name': "Octavia Butler's"}, {'Label': 'ORG', 'Matches': [{'End': 58, 'Start': 41, 'Text': 'Ursula K. Le Guin'}], 'Name': 'Ursula K. Le Guin'}, {'Label': 'PERSON', 'Matches': [{'End': 76, 'Start': 60, 'Text': 'Samuel R. Delany'}], 'Name': 'Samuel R. Delany'}, {'Label': 'PERSON', 'Matches': [{'End': 93, 'Start': 82, 'Text': 'Joanna Russ'}], 'Name': 'Joanna Russ'}], 'intent': "The subject is providing information about Octavia Butler's contemporaries."}}, 'token_count': 27}),     Document(page_content='You might want to read Ursula K. Le Guin or Joanna Russ.', metadata={'score': 0.7594731095320668, 'uuid': '6951f2fd-dfa4-4e05-9380-f322ef8f72f8', 'created_at': '2023-06-26T23:40:22.80464Z', 'role': 'ai', 'metadata': {'system': {'entities': [{'Label': 'ORG', 'Matches': [{'End': 40, 'Start': 23, 'Text': 'Ursula K. Le Guin'}], 'Name': 'Ursula K. Le Guin'}, {'Label': 'PERSON', 'Matches': [{'End': 55, 'Start': 44, 'Text': 'Joanna Russ'}], 'Name': 'Joanna Russ'}]}}, 'token_count': 18})]

We can also use the Zep sync API to retrieve results:

    zep_retriever.get_relevant_documents("Who wrote Parable of the Sower?")

        [Document(page_content='Parable of the Sower is a science fiction novel by Octavia Butler, published in 1993. It follows the story of Lauren Olamina, a young woman living in a dystopian future where society has collapsed due to environmental disasters, poverty, and violence.', metadata={'score': 0.889661105796371, 'uuid': 'db60ff57-f259-4ec4-8a81-178ed4c6e54f', 'created_at': '2023-06-26T23:40:22.816214Z', 'role': 'ai', 'metadata': {'system': {'entities': [{'Label': 'GPE', 'Matches': [{'End': 20, 'Start': 15, 'Text': 'Sower'}], 'Name': 'Sower'}, {'Label': 'PERSON', 'Matches': [{'End': 65, 'Start': 51, 'Text': 'Octavia Butler'}], 'Name': 'Octavia Butler'}, {'Label': 'DATE', 'Matches': [{'End': 84, 'Start': 80, 'Text': '1993'}], 'Name': '1993'}, {'Label': 'PERSON', 'Matches': [{'End': 124, 'Start': 110, 'Text': 'Lauren Olamina'}], 'Name': 'Lauren Olamina'}]}}, 'token_count': 56}),     Document(page_content="Write a short synopsis of Butler's book, Parable of the Sower. What is it about?", metadata={'score': 0.885754241595424, 'uuid': 'f1a5981a-8f6d-4168-a548-6e9c32f35fa1', 'created_at': '2023-06-26T23:40:22.809621Z', 'role': 'human', 'metadata': {'system': {'entities': [{'Label': 'ORG', 'Matches': [{'End': 32, 'Start': 26, 'Text': 'Butler'}], 'Name': 'Butler'}, {'Label': 'WORK_OF_ART', 'Matches': [{'End': 61, 'Start': 41, 'Text': 'Parable of the Sower'}], 'Name': 'Parable of the Sower'}]}}, 'token_count': 23}),     Document(page_content='Who was Octavia Butler?', metadata={'score': 0.7758688965570713, 'uuid': '361d0043-1009-4e13-a7f0-8aea8b1ee869', 'created_at': '2023-06-26T23:40:22.709886Z', 'role': 'human', 'metadata': {'system': {'entities': [{'Label': 'PERSON', 'Matches': [{'End': 22, 'Start': 8, 'Text': 'Octavia Butler'}], 'Name': 'Octavia Butler'}], 'intent': 'The subject wants to know about the identity or background of an individual named Octavia Butler.'}}, 'token_count': 8}),     Document(page_content="Octavia Butler's contemporaries included Ursula K. Le Guin, Samuel R. Delany, and Joanna Russ.", metadata={'score': 0.7602672137411663, 'uuid': '56c45e8a-0f65-45f0-bc46-d9e65164b563', 'created_at': '2023-06-26T23:40:22.778836Z', 'role': 'ai', 'metadata': {'system': {'entities': [{'Label': 'PERSON', 'Matches': [{'End': 16, 'Start': 0, 'Text': "Octavia Butler's"}], 'Name': "Octavia Butler's"}, {'Label': 'ORG', 'Matches': [{'End': 58, 'Start': 41, 'Text': 'Ursula K. Le Guin'}], 'Name': 'Ursula K. Le Guin'}, {'Label': 'PERSON', 'Matches': [{'End': 76, 'Start': 60, 'Text': 'Samuel R. Delany'}], 'Name': 'Samuel R. Delany'}, {'Label': 'PERSON', 'Matches': [{'End': 93, 'Start': 82, 'Text': 'Joanna Russ'}], 'Name': 'Joanna Russ'}], 'intent': "The subject is providing information about Octavia Butler's contemporaries."}}, 'token_count': 27}),     Document(page_content='You might want to read Ursula K. Le Guin or Joanna Russ.', metadata={'score': 0.7596040989115522, 'uuid': '6951f2fd-dfa4-4e05-9380-f322ef8f72f8', 'created_at': '2023-06-26T23:40:22.80464Z', 'role': 'ai', 'metadata': {'system': {'entities': [{'Label': 'ORG', 'Matches': [{'End': 40, 'Start': 23, 'Text': 'Ursula K. Le Guin'}], 'Name': 'Ursula K. Le Guin'}, {'Label': 'PERSON', 'Matches': [{'End': 55, 'Start': 44, 'Text': 'Joanna Russ'}], 'Name': 'Joanna Russ'}]}}, 'token_count': 18})]